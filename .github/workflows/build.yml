name: Build Kivy APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Setup Java 17 (temurin)
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git zip unzip curl \
            libffi-dev libssl-dev zlib1g-dev \
            libbz2-dev libreadline-dev libsqlite3-dev
          python -m pip install --upgrade pip wheel setuptools
          python -m pip install "cython<3.1" buildozer==1.5.0 virtualenv

      - name: Prepare Android SDK / cmdline-tools / licenses
        env:
          ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
        run: |
          set -e
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          curl -L https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o /tmp/cmdtools.zip
          unzip -q /tmp/cmdtools.zip -d /tmp/cmdtools
          mv /tmp/cmdtools/cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"

          yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses
          "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" \
              "platform-tools" \
              "platforms;android-33" \
              "build-tools;33.0.2" \
              "ndk;25.1.8937393" >/dev/null

          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

      - name: Build with Buildozer (debug)
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          buildozer android debug

      - name: Locate APK
        id: findapk
        run: |
          set -e
          ROOT="$HOME/.buildozer/android/platform"
          echo "Buscando APK en $ROOT"
          APK=$(find "$ROOT" -type f -name "*.apk" | head -n1 || true)
          if [ -z "$APK" ]; then
            echo "No se encontró APK. Mostrando árbol de directorios para diagnóstico:"
            ls -R "$ROOT" || true
            exit 1
          fi
          echo "APK encontrado: $APK"
          echo "apk=$APK" >> $GITHUB_OUTPUT

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: bitacora-apk
          path: ${{ steps.findapk.outputs.apk }}